version: 2

general:
    branches:
        only:
            - egt_circleci
jobs:
    build:
        machine:
            image: circleci/classic:latest

        steps:
            - checkout

            - run:
                  name: Construct Containers
                  command: |
                    docker-compose build
                    docker-compose up -d

            - run:
                  name: Init Symfony
                  command: |
                    docker-compose exec php composer install
                    docker-compose exec php bin/console  doctrine:database:create
                    docker-compose exec php bin/console  doctrine:schema:update --force
                    docker-compose exec php bin/console doctrine:fixtures:load
                    docker-compose exec php bin/console cache:clear
                    docker-compose exec php HTTPDUSER=`ps axo user,comm | grep -E '[a]pache|[h]ttpd|[_]www|[w]ww-data|[n]ginx' | grep -v root | head -1 | cut -d\  -f1`
                    docker-compose exec php setfacl -R -m u:$HTTPDUSER:rwX -m u:`whoami`:rwX var
                    docker-compose exec php setfacl -dR -m u:$HTTPDUSER:rwX -m u:`whoami`:rwX var
                    docker-compose exec php mkdir -p var/jwt
                    docker-compose exec php openssl genrsa -passout pass:imie -out var/jwt/private.pem -aes256 4096
                    docker-compose exec php openssl rsa passin pass:imie -pubout -in var/jwt/private.pem -out var/jwt/public.pem
                    docker-compose exec php rm /app/config/parameters.yml
                    docker-compose exec php mv /app/config/parameters.yml.dist /app/config/parameters.yml

            - run:
                name: Test curl login
                command: |
                    curl -X POST http://127.0.0.1:3001/app_dev.php/login_check -d _username=test@test.fr -d _password=p@ssword
